<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0f172a" />
  <title>College Notes Portal</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{
      font-family: 'Poppins', sans-serif;
      background: radial-gradient(circle at top left,#1e293b,#0f172a);
      color:#e6eef8;
      overflow-x:hidden;
      -webkit-tap-highlight-color: transparent;
    }
    h1,h2{ font-weight:600; }
    .step-card{
      transition: transform .28s cubic-bezier(.2,.9,.3,1), box-shadow .28s;
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border: 1px solid rgba(255,255,255,0.04);
    }
    .step-card:hover{ transform: translateY(-8px) scale(1.02); box-shadow: 0 18px 40px rgba(12,20,40,0.7); }
    .step-card .icon-wrap{ width:56px; height:56px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:20px; background: linear-gradient(135deg,#7c3aed 0%, #06b6d4 100%); color:white; }
    .btn-accent{
      background: linear-gradient(135deg,#7c3aed 0%, #06b6d4 100%);
      color:white;
      padding:12px 18px;
      border-radius:8px;
      font-weight:600;
      transition:all .25s ease;
      min-height:44px; /* touch target */
    }
    .btn-accent:hover{ transform:translateY(-2px) scale(1.03); box-shadow:0 8px 20px rgba(0,0,0,0.35); }
    .btn-back{
      font-size:0.95rem;
      color:#cbd5e1;
      transition:color .2s;
      padding:10px 12px;
      border-radius:8px;
      min-height:44px; /* touch target */
    }
    .btn-back:hover{ color:#fff; }

    .hidden-step{ display:none; }
    .fade-in{ animation:fadeIn .5s ease forwards; }
    @keyframes fadeIn{ from{opacity:0; transform:translateY(20px);} to{opacity:1; transform:translateY(0);} }

    /* Reduce motion for users who prefer it */
    @media (prefers-reduced-motion: reduce){
      .step-card{ transition: none; }
      .step-card:hover{ transform:none; box-shadow:none; }
      .fade-in{ animation:none; }
    }

    /* Mobile tweaks */
    @media (max-width: 640px){
      header{ padding-left: 16px; padding-right: 16px; padding-top: 12px; padding-bottom: 12px; }
      .step-card{ padding:16px; }
    }
  </style>
</head>
<body>
  <header class="flex items-center justify-between px-6 py-6 relative z-10">
    <div class="flex items-center gap-3">
      <div class="w-12 h-12 flex items-center justify-center rounded-full bg-gradient-to-r from-indigo-500 to-cyan-400 shadow-lg animate-bounce">
        <i class="fas fa-graduation-cap text-xl text-white"></i>
      </div>
      <h1 class="text-2xl md:text-3xl font-bold bg-gradient-to-r from-indigo-400 to-cyan-300 bg-clip-text text-transparent">College Notes Portal</h1>
    </div>
    <div>
      <a href="/admin.html" id="adminLogin" class="btn-accent text-sm md:text-base whitespace-nowrap">Admin Login</a>
    </div>
  </header>

  <main class="flex flex-col items-center justify-center min-h-[70vh] p-6 relative z-10 space-y-10">
    <!-- Step 1: Program -->
    <div id="stepClass" class="w-full max-w-2xl">
      <h2 class="text-2xl md:text-3xl font-semibold mb-8 text-center">üéì Select Your Program</h2>
      <div class="grid grid-cols-1 gap-6"></div>
    </div>

    <!-- Step 2: Semester -->
    <div id="stepSemester" class="w-full max-w-3xl hidden-step">
      <div class="flex justify-between items-center mb-8">
        <h2 class="text-2xl md:text-3xl font-semibold">üìÖ Select Your Semester</h2>
        <button class="btn-back" onclick="goBack(stepSemester, stepClass)">‚Üê Back</button>
      </div>
      <div id="semesterGrid" class="grid grid-cols-2 md:grid-cols-4 gap-6"></div>
    </div>

    <!-- Step 3: Subject -->
    <div id="stepSubject" class="w-full max-w-4xl hidden-step">
      <div class="flex justify-between items-center mb-8">
        <h2 class="text-2xl md:text-3xl font-semibold">üìö Select Subject</h2>
        <button class="btn-back" onclick="goBack(stepSubject, stepSemester)">‚Üê Back</button>
      </div>
      <div id="subjectGrid" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
    </div>

    <!-- Step 4: Notes -->
    <div id="stepNotes" class="w-full max-w-5xl hidden-step">
      <div class="flex justify-between items-center mb-8">
        <h2 class="text-2xl md:text-3xl font-semibold">üìù Available Notes</h2>
        <button class="btn-back" onclick="goBack(stepNotes, stepSubject)">‚Üê Back</button>
      </div>
      <div class="overflow-x-auto bg-white/10 rounded-2xl p-6 shadow-lg fade-in">
        <table class="min-w-full text-sm">
          <thead class="text-slate-300/80">
            <tr>
              <th class="px-3 py-2 text-left">Title</th>
              <th class="px-3 py-2 text-left">File</th>
              <th class="px-3 py-2 text-left hidden sm:table-cell">Uploaded</th>
              <th class="px-3 py-2 text-left hidden sm:table-cell">Actions</th>
            </tr>
          </thead>
          <tbody id="notesTable" class="divide-y divide-white/10"></tbody>
        </table>
      </div>
    </div>
  </main>

  <script>
    const stepClass=document.getElementById('stepClass');
    const stepSemester=document.getElementById('stepSemester');
    const stepSubject=document.getElementById('stepSubject');
    const stepNotes=document.getElementById('stepNotes');
    const semesterGrid=document.getElementById('semesterGrid');
    const subjectGrid=document.getElementById('subjectGrid');
    const notesTable=document.getElementById('notesTable');

    let selectedProgram="",selectedSemesterId="",selectedSubjectId="";

    function showStep(step){ step.classList.remove('hidden-step'); step.classList.add('fade-in'); }
    function hideStep(step){ step.classList.add('hidden-step'); step.classList.remove('fade-in'); }
    function goBack(current, previous){ hideStep(current); showStep(previous); }

    async function api(path, opts={}){
      console.log("‚û°Ô∏è Fetch:", path);
      const res = await fetch(path, opts);
      if(!res.ok) throw new Error(await res.text());
      return res.json();
    }

    async function buildPrograms(){
      const container = document.querySelector('#stepClass .grid');
      container.innerHTML = '';
      const classes = await api('/api/classes');
      classes.forEach(c=>{
        const div = document.createElement('div');
        div.className = 'step-card flex items-center gap-4 justify-center';
        div.dataset.classId = c._id;
        div.innerHTML = `<div class="icon-wrap"><i class="fa-solid fa-graduation-cap"></i></div><p class="font-semibold text-lg">${c.name}</p>`;
        div.addEventListener('click', ()=> selectProgram(c._id));
        container.appendChild(div);
      });
    }

    async function selectProgram(classId){
      selectedProgram = classId;
      hideStep(stepClass);
      semesterGrid.innerHTML = '';
      const sems = await api('/api/semesters?class_id='+classId); // ‚úÖ fixed param
      sems.forEach(s=>{
        const div = document.createElement('div');
        div.className = 'step-card text-center';
        div.dataset.semId = s._id;
        div.innerHTML = `<div class="icon-wrap"><i class="fas fa-calendar-alt"></i></div><p>${s.name}</p>`;
        semesterGrid.appendChild(div);
      });
      showStep(stepSemester);
    }

    semesterGrid.addEventListener('click', async (e)=>{
      const card = e.target.closest('.step-card');
      if(!card) return;
      selectedSemesterId = card.dataset.semId;
      hideStep(stepSemester);
      subjectGrid.innerHTML = '';
      const subjects = await api('/api/subjects?semester_id='+selectedSemesterId); // ‚úÖ fixed param
      subjects.forEach(sub=>{
        const icon = sub.name.includes('Math')? 'fa-square-root-variable' : sub.name.includes('Computer')? 'fa-laptop-code':'fa-book';
        const div = document.createElement('div');
        div.className = 'step-card text-center';
        div.dataset.subId = sub._id;
        div.innerHTML = `<div class="icon-wrap"><i class="fas ${icon}"></i></div><p>${sub.name}</p>`;
        subjectGrid.appendChild(div);
      });
      showStep(stepSubject);
    });

    subjectGrid.addEventListener('click', async (e)=>{
      const card = e.target.closest('.step-card');
      if(!card) return;
      selectedSubjectId = card.dataset.subId;
      hideStep(stepSubject);
      notesTable.innerHTML = '';
      const notes = await api('/api/notes?subject_id='+selectedSubjectId); // ‚úÖ fixed param
      notes.forEach(n=>{
        const fileUrl = '/uploads/' + n.filename;
        const uploaded = n.uploadedAt ? new Date(n.uploadedAt).toISOString().split('T')[0] : '';
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-white/5 transition';
        tr.innerHTML = `<td class="px-3 py-3">${n.title}</td>
          <td class="px-3 py-3"><a class="btn-accent text-xs" href="${fileUrl}" target="_blank">${n.originalName}</a></td>
          <td class="px-3 py-3 hidden sm:table-cell">${uploaded}</td>
          <td class="px-3 py-3 hidden sm:table-cell"><div class="flex gap-2"><a class="btn-accent text-xs" href="${fileUrl}" target="_blank">View</a></div></td>`;
        notesTable.appendChild(tr);
      });
      showStep(stepNotes);
    });

    // initial load
    buildPrograms().catch(e=> console.error("Init error:", e));
  </script>
</body>
</html>
